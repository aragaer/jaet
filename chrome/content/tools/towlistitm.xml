<?xml version="1.0"?>
<bindings 
    xmlns="http://www.mozilla.org/xbl"
    xmlns:xbl="http://www.mozilla.org/xbl"
    xmlns:xul="http://www.mozilla.org/keymaster/gatekeeper/there.is.only.xul">
    <binding id="towlistitem" extends="chrome://global/content/bindings/richlistbox.xml#richlistitem">
        <content>
            <xul:hbox anonid="wrap" flex="1">
            <xul:vbox flex="1">
                <xul:hbox anonid="label" width="100%">
                    <xul:label xbl:inherits="value=name" class="header" />
                </xul:hbox>
                <xul:hbox style="border: none; overflow-x: auto; overflow-y: hidden">
                    <xul:hbox anonid="pos_fit"/>
                </xul:hbox>
            </xul:vbox>
            </xul:hbox>
        </content>
        <implementation>
            <constructor><![CDATA[
                this.db = Components.classes["@aragaer/eve/db;1"].getService(Components.interfaces.nsIEveDBService);
                this.fit = document.getAnonymousElementByAttribute(this,"anonid","pos_fit");
            ]]></constructor>
            <property name="tower">
                <setter><![CDATA[
                    this._tower = val; /* Make sure we get nsIEveControlTower! */
                    this._tt = val.type.QueryInterface(Components.interfaces.nsIEveControlTowerType);
                    var ttid = this._tt.id;
                    var labelbox = document.getAnonymousElementByAttribute(this,"anonid","label");
                    if (!this.img) {
                        var wrap = document.getAnonymousElementByAttribute(this,"anonid","wrap");
                        this.img = document.createElement('image');
                        wrap.insertBefore(this.img, wrap.firstChild);
                    }
                    this.img.setAttribute('src', "chrome://jaet/content/images/"+ttid+".png");
                    if (!this.tlabel) {
                        this.tlabel = document.createElement("label");
                        labelbox.appendChild(this.tlabel);
                    }
                    this.tlabel.setAttribute('value',"("+this._tt.name+")");
                    if (!this.conslabel) {
                        var sp = document.createElement('spacer');
                        sp.setAttribute('flex', "100");
                        labelbox.appendChild(sp);
                        this.conslabel = document.createElement('label');
                        labelbox.appendChild(this.conslabel);
                    }

                    this.conslabel.value = "Power: "+this._tower.powerUsage + '/' + this._tt.powerGrid +
                            "; CPU: "+this._tower.CPUUsage + '/' + this._tt.CPU;

                    this.setAttribute("name", this._tower.name);
                    this.setAttribute("value", this._tower.id);
                    return val;
                ]]></setter>
                <getter><![CDATA[
                    return this._tower;
                ]]></getter>
            </property>
            <property name="id" onget="return this.value" />
            <property name="structures">
                <setter><![CDATA[
                    var me = this;
                    var observer = this.dragobserver;
                    this.structs = val;
                    while (this.fit.firstChild)
                        this.fit.removeChild(this.fit.firstChild);
                    if (!val)
                        return val;
                    val.forEach(function (el) {
                        var itm = document.createElement('image');
                        itm.setAttribute('name', el.type.name);
                        me.fit.appendChild(itm);
                        itm.item = el;
                        itm.pos = me;
                    });
                    return val;
                ]]></setter>
            </property>
            <method name="add_struct">
                <parameter name="struct" />
                <body><![CDATA[
                    this.fit.appendChild(struct);
                    this.structs.push(struct.item);
                    struct.pos = this;
                ]]></body>
            </method>
            <method name="del_struct">
                <parameter name="struct" />
                <body><![CDATA[
                    this.fit.removeChild(struct);
                    var i;
                    for (i = 0; i < this.structs.length; i++)
                        if (this.structs[i] == struct) {
                            splice(i, 1);
                            break;
                        }
                    struct.pos = null;
                ]]></body>
            </method>
        </implementation>
        <handlers>
            <handler event="dragenter"><![CDATA[
                event.preventDefault();
                event.dataTransfer.dropEffect = "move";
            ]]></handler>
            <handler event="dragover"><![CDATA[
                event.preventDefault();
                event.dataTransfer.dropEffect = "move";
            ]]></handler>
            <handler event="dragdrop"><![CDATA[
                var item = event.dataTransfer.mozGetDataAt('application/x-moz-node', 0);
                item.moveTo(this);
            ]]></handler>
        </handlers>
    </binding>
    <binding id="struct" extends="xul:image">
        <implementation>
            <property name="item">
                <setter><![CDATA[
                    this._item = val;
                    this.setAttribute('src', "chrome://jaet/content/images/"+val.type.id+".png");
                    this.setAttribute('tooltiptext', val.type.name);
                    return val;
                ]]></setter>
                <getter><![CDATA[
                    return this._item;
                ]]></getter>
            </property>
            <property name="width" value="100px" />
            <property name="height" value="100px" />
            <property name="draggable" value="true" />
            <method name="moveTo">
                <parameter name="to" />
                <body><![CDATA[
                    to.api.setStarbase(this._item, to.tower ? to.tower.id : 0);
                    this.pos.del_struct(this);
                    to.add_struct(this);
                ]]></body>
            </method>
        </implementation>
        <handlers>
            <handler event="dragstart"><![CDATA[
                event.dataTransfer.effectAllowed = "move";
                event.dataTransfer.mozSetDataAt('application/x-moz-node', this, 0);
                event.dataTransfer.setData("text/plain", this._item.type.name);
            ]]></handler>
        </handlers>
    </binding>
</bindings>

